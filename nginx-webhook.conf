# Nginx konfiguratsiyasi - Telegram Bot Webhook
# 443 portdan 80 portga reverse proxy

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name 20.160.233.197;

    # SSL sertifikatlar (agar mavjud bo'lsa)
    # Let's Encrypt yoki o'zingizning sertifikatingizni ishlatishingiz mumkin
    # ssl_certificate /etc/nginx/ssl/fullchain.pem;
    # ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    # Self-signed sertifikat (test uchun) - production da to'g'ri sertifikat ishlating
    ssl_certificate /etc/nginx/ssl/telegram_bot.crt;
    ssl_certificate_key /etc/nginx/ssl/telegram_bot.key;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Bot webhook endpoint
    location /webhook {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Telegram webhook uchun kerakli sozlamalar
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        
        # Webhook secret token (agar ishlatilayotgan bo'lsa)
        # X-Telegram-Bot-Api-Secret-Token header ni o'tkazish
        proxy_set_header X-Telegram-Bot-Api-Secret-Token $http_x_telegram_bot_api_secret_token;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Boshqa barcha requestlar
    location / {
        return 404;
    }
}

# HTTP dan HTTPS ga redirect (80 port)
server {
    listen 80;
    listen [::]:80;
    server_name 20.160.233.197;

    # Webhook endpoint - to'g'ridan-to'g'ri bot ga (nginx o'rniga)
    location /webhook {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_set_header X-Telegram-Bot-Api-Secret-Token $http_x_telegram_bot_api_secret_token;
    }

    location / {
        return 404;
    }
}
